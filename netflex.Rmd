---
title: "NETFLEX"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    favicon: "flavicon.jpeg"
    source_code: embed
    theme: spacelab
    css: "src/netflex-lightened.css"
    social: "menu" 
    vertical_layout: fill
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(shiny)
library(shinythemes)
library(shinydashboard)
library(shinydashboardPlus)
library(shinyjs)
library(shinyBS)
library(shinyLP)
library(shinycssloaders)
library(shinybusy)
library(flexdashboard)
library(leaflet)
library(viridis)
library(shinyWidgets)
library(waiter)
library(hrbrthemes)
library(htmltools)
library(tidyr)
library(dplyr)
library(FactoMineR)
library(factoextra)
library(GGally)
library(rgdal)
library(sp)
library(rgeos)
library(scales)
library(data.table)
library(DT)
library(dygraphs)
library(plotly)
library(xts)
library(magrittr)
library(ggridges)
library(gplots)
library(wordcloud)
library(vov)
```


```{r global, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
dat <- read.csv("src/data/netflex5.csv")
countriesborders <- readOGR("src/TM_WORLD_BORDERS_SIMPL-0.3.shp")
dat$Show_type[is.na(dat$Show_type)] <- 'undefined'
dat$Genre[is.na(dat$Genre)] <- 'undefined'
# genre <- paste(unlist(dat$Genre), collapse=' ')%>%
#   strsplit(" ")%>%
#   unlist()%>%
#   sub(",$",  "", .)%>%
#   unique()
mat <- read.csv('src/data/mat.csv',row.names = 1, encoding = "utf8")
```

#  Home Page {data-orientation=rows}     

Row 
-------------------------------------

```{r}
add_busy_bar(timeout = 400, color = "#c7636a", centered = FALSE, height = "6px")


tags$img(
     src = "src/bckgrnd0.jpeg",
     style = 'position: fixed'
   )
```

### ValBox {data-height=800}

```{r}
my_jumbotron <- function(header , content, button = TRUE, button_link, ...){
  
  button_label = c(...)
  if (button){
    div(class = "jumbotron",
        h1(header), p(content), p(a(href = button_link ,target="_blank",
        class = "btn btn-primary btn-lg button", role= 'button', button_label)))
} else {
    div(class = "jumbotron", h1(header), p(content))
}
  
}

fixedPage(
use_vov(),
    fade_in_up(
my_jumbotron(header="Welcome to NETFLEX", content="Please call attention to important features of the app", button =  "True", button_link="https://github.com/Glastos/Projet-Shiny", button_Label = "Check our repo'"))

)
```


Row {data-height=150}
-------------------------------------

Row 
-------------------------------------
```{r}
```

### Profiles
```{r}
renderValueBox({

valueBox(
                tags$p(length(unique(dat$Profile)),
                style = "font-size: 200%; color:	#FFFFFF;"),
                tags$q("Netflix Profiles",style = "font-size: 150%; color:	#FFFFFF;"),
                icon ="fa-users",color = "green")

})
```


### Movies seen
```{r}
renderValueBox({
  
valueBox(
                tags$p(table(dat$Show_type=="movie")[2],
                style = "font-size: 200%; color:	#FFFFFF;"),
                tags$q("Movies seen",style = "font-size:150%; color:	#FFFFFF;"),
                icon ="fa-video", color = "orange")

})
```

### Series seen
```{r}
renderValueBox({
  
valueBox(
                tags$p(table(dat$Show_type=="series")[2],
                style = "font-size: 200%; color:#FFFFFF;"),
                tags$q("Series seen",style = "font-size: 150%; color:	#FFFFFF;"),
                icon ="fa-film", color="red")

  })
```

Row
-------------------------------------
```{r}
```



# Explanatory visualization {data-orientation=column}

## Input {.sidebar}

```{r echo=FALSE}
selectInput("profile", "Choose profile", choices = c("All",unique(dat$Profile)), selected = "All")
radioButtons("time_range_1", "Time range", choices = list("All time" = 1, "Monthly" = 2, "Weekly" = 3, "Daily" = 4), selected = 1)
```

## Column {.tabset}
### Worldcloud

```{r}

genres <- reactive({
  if (input$profile != "All") {
    genres <- data.frame(t(mat[input$profile,]))
    colnames(genres) <- "Count"
  } else {
    genres <- data.frame("Count" = colSums(mat))
  }
})

renderPlot({
  wordcloud(words = as.character(colnames(mat)), freq = c(genres()[,1]), min.freq = 1, max.words=25, random.order=FALSE, rot.per=0.35,
            colors=brewer.pal(8, "Dark2"))
})
```

### Visu

```{r echo=FALSE}
dat_p <- reactive({
  if (input$profile != "All") {
    dat_p <- filter(dat, Profile == input$profile)
  } else {
    dat_p <- dat
  }
})

output$dygraphAllTime <- renderDygraph({
        dat_d <- dat_p()[,c("Show_type", "Start_time")] %>%
            mutate(Date = as.Date(Start_time))%>%
            group_by(Date, Show_type)%>%
            tally()%>%
            pivot_wider(names_from = Show_type, values_from = n)%>%
            mutate_at(c('movie','series','undefined'),~replace(., is.na(.), 0))
        dat_t <-  xts(dat_d[2:4], dat_d$Date)
        dygraph(dat_t)%>%
            dyRangeSelector(dateWindow = c(min(dat_p()$Start_time), max(dat_p()$Start_time)))
    })
```

```{r echo=FALSE}
output$plotYearly <- renderPlotly({
        dat_d <- dat_p()[,c("Show_type", "Month")] %>%
            group_by(Month, Show_type)%>%
            tally()%>%
            pivot_wider(names_from = Show_type, values_from = n)%>%
            mutate_at(c('movie','series','undefined'),~replace(., is.na(.), 0))
        dat_d$Month <- factor(dat_d$Month, levels = month.name)
        plot_ly(dat_d, x = ~Month, y = ~movie, name = "Movies", type = "bar", colors = viridis_pal(option = "D")(3))%>%
          add_trace(y = ~series, name = 'Series')%>%
          add_trace(y = ~undefined, name = 'Undefined')%>%
          layout(yaxis = list(title = 'Count'), barmode = 'group')
    })
```

```{r echo=FALSE}
output$plotWeekly <- renderPlotly({
        dat_d <- dat_p()[,c("Show_type", "Day")] %>%
            group_by(Day, Show_type)%>%
            tally()%>%
            pivot_wider(names_from = Show_type, values_from = n)%>%
            mutate_at(c('movie','series','undefined'),~replace(., is.na(.), 0))
        dat_d$Day <- factor(dat_d$Day, levels = c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'))
        plot_ly(dat_d, x = ~Day, y = ~movie, name = "Movies", type = "bar", colors = viridis_pal(option = "D")(3))%>%
          add_trace(y = ~series, name = 'Series')%>%
          add_trace(y = ~undefined, name = 'Undefined')%>%
          layout(yaxis = list(title = 'Count'), barmode = 'group')
    })
```

```{r echo=FALSE}

output$plotHourly <- renderPlotly({
        dat_d <- dat_p()[,c("Show_type", "Hours")] %>%
            group_by(Hours, Show_type)%>%
            tally()%>%
            pivot_wider(names_from = Show_type, values_from = n)%>%
            mutate_at(c('movie','series','undefined'),~replace(., is.na(.), 0))
        plot_ly(dat_d, x = ~Hours, y = ~movie, name = "Movies", type = "bar", colors = viridis_pal(option = "D")(3))%>%
          add_trace(y = ~series, name = 'Series')%>%
          add_trace(y = ~undefined, name = 'Undefined')%>%
          layout(yaxis = list(title = 'Count'), barmode = 'group')
    })
```

```{r echo=FALSE}
output$graph1 <- renderUI({
  if (input$time_range_1 == 1) {
    dygraphOutput("dygraphAllTime")
  } else if (input$time_range_1 == 2) {
        plotlyOutput("plotYearly")
  } else if (input$time_range_1 == 3) {
        plotlyOutput("plotWeekly")
  } else {
        plotlyOutput("plotHourly")
  }
})
uiOutput("graph1")
```


### Mapping
```{r map1, eval=FALSE, include=FALSE}
# Mapping
names(countriesborders@data)[5] <- "Country"
Countries <- unique(dat$Country)
mySHPdata <- countriesborders[countriesborders$Country %in% Countries,]
newdf <- merge(mySHPdata, dat[,c("Country","Account")], by="Country",duplicateGeoms = TRUE) #A opti
AutreSHP <- countriesborders[!countriesborders$Country %in% Countries,]%>%
            merge(dat[,c("Country","Account")], by="Country",duplicateGeoms = TRUE )

```


```{r map2, eval=FALSE, include=FALSE}
# # Leaflet map

options(viewer = NULL)

renderLeaflet({
  newdfx <- newdf
  if (input$profile != "All") {
     newdfx <- newdf[newdf$Account==input$profile,]

  } else {
      newdfx <- newdf
  }
# Color palette
factpal2 <- colorFactor(viridis(2), newdfx@data$Country, reverse = T)


  leaflet()%>%
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels,
                     options = providerTileOptions(noWrap = TRUE)) %>%
  setView(1, 15, 2.5) %>%
  addPolygons(data=newdfx,
              stroke=TRUE,
              fillColor = ~factpal2(newdfx@data$Country),
              color = "black",
              weight = 0.5, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              label = newdfx@data$Profile) %>%
  addPolygons(data=AutreSHP,
              fillColor = "black",
              color = "black",
              weight = 0.2, smoothFactor = 0.5,
              opacity = 0.5, fillOpacity = 0.8) %>%
  leaflet::addLegend(pal=factpal2, values=newdfx@data$Country, opacity=1)
})

```


# Analysis

## Input {.sidebar}

```{r echo=FALSE}
br()
materialSwitch(inputId = "leaveVal", label = "Drop Valentin!", status = "warning")
```

## Column {.tabset}


### Balloon
```{r}
reactive_df <- reactive({

          if (input$leaveVal){
            return(mat[-26,-c(3,25)])
          } else {
            return(mat[,-c(3,25)])}
})

renderPlot({
  dt <- as.table(as.matrix(reactive_df()[,-c(23:28)]))

  balloonplot(t(dt), main = "Most seen genres",
              xlab = "", ylab = "",
              dotsize = 4, dotcolor = "#E50914",
              label = FALSE, show.margins = FALSE,repel = TRUE)
})
```

### MCA

```{r}
renderPlot({
  res.ca <- CA(reactive_df(), graph=F)
  fviz_ca_biplot(res.ca, repel = TRUE)
})
```

### Biplot_col
```{r}
renderPlot({
  res.ca <- CA(reactive_df(), graph=F)
  fviz_ca_col(res.ca, col.col = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)
})
```

### Biplot_row
```{r}
renderPlot({
  res.ca <- CA(reactive_df(), graph=F)
  fviz_ca_row(res.ca, col.row = "cos2",
               gradient.cols = c ("#00AFBB", "#E7B800", "#FC4E07"),
               repel = TRUE)
})
```


### HCPC
```{r}

renderPlot({
  res.ca <- CA(reactive_df(), graph=F)
  res.hcpc <- HCPC(res.ca, graph = F)
  fviz_dend(res.hcpc,
            cex = 0.7,
            palette = "jco",
            rect = TRUE, rect_fill = TRUE,
            rect_border = "jco",
            labels_track_height = 0.8,
            show_labels = TRUE,
            color_labels_by_k=T)

})
```

### Clusters
```{r}
renderPlot({
    res.ca <- CA(reactive_df(), graph=F)
    res.hcpc <- HCPC(res.ca, graph = F)
    fviz_cluster(res.hcpc, frame.type = "norm",
            frame.level = 0.68,outlier.color = "black",
            repel=T, show.clust.cent=TRUE,
            ggtheme = theme_bw())
})
```


# Data source
```{r}
tags$style(HTML("
                    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_processing, .dataTables_wrapper .dataTables_paginate, .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
                    color: #000000; }

                    .dataTables_wrapper .dataTables_paginate .paginate_button{box-sizing:border-box;display:inline-block;min-width:1.5em;padding:0.5em 1em;margin-left:2px;text-align:center;text-decoration:none !important;cursor:pointer;*cursor:hand;color:#ffffff !important;border:1px solid transparent;border-radius:2px}

                    .dataTables_length select {
                           color: #ffffff;
                           background-color: #ffffff
                           }
                    .dataTables_filter input {
                            color: #ffffff;
                            background-color: #ffffff}thead {
                    color: #ffffff;
                    }tbody {
                    color: #000000;
                    }"))

renderDataTable({DT::datatable(dat[,-1], options = list(scrollX = TRUE,
                 sScrollY = '75vh', scrollCollapse = TRUE), extensions = list("Scroller"))})
```
